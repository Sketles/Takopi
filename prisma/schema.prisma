generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model User {
  id           String        @id @default(cuid())
  username     String        @unique
  email        String        @unique
  password     String
  role         String        @default("Explorer")
  avatar       String?
  banner       String?
  bio          String?
  location     String?
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  comments     Comment[]
  contents     Content[]
  following    Follow[]      @relation("UserFollowing")
  followers    Follow[]      @relation("UserFollowers")
  likes        Like[]
  pins         Pin[]
  purchases    Purchase[]
  transactions Transaction[]

  @@map("users")
}

model Content {
  id               String     @id @default(cuid())
  title            String
  description      String
  shortDescription String?
  contentType      String
  category         String
  files            Json
  coverImage       String?
  additionalImages Json?
  price            Int        @default(0)
  currency         String     @default("CLP")
  isFree           Boolean    @default(false)
  license          String     @default("personal")
  customLicense    String?
  visibility       String     @default("public")
  status           String     @default("draft")
  isPublished      Boolean    @default(false)
  tags             String[]
  customTags       String[]
  views            Int        @default(0)
  downloads        Int        @default(0)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  publishedAt      DateTime?
  authorId         String
  isListed         Boolean    @default(true)
  deletedAt        DateTime?
  comments         Comment[]
  author           User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  likes            Like[]
  pins             Pin[]
  purchases        Purchase[]

  @@index([authorId])
  @@index([contentType])
  @@index([status])
  @@index([isPublished])
  @@index([createdAt])
  @@index([views])
  @@index([price])
  @@index([isListed])
  @@index([contentType, isPublished, status])
  @@index([authorId, isPublished])
  @@map("contents")
}

model Comment {
  id        String   @id @default(cuid())
  text      String
  contentId String
  userId    String
  likeCount Int      @default(0)
  likedBy   String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  content   Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([contentId])
  @@index([userId])
  @@map("comments")
}

model Like {
  id        String   @id @default(cuid())
  contentId String
  userId    String
  createdAt DateTime @default(now())
  content   Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([contentId, userId])
  @@index([contentId])
  @@index([userId])
  @@map("likes")
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())
  follower    User     @relation("UserFollowing", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("UserFollowers", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("follows")
}

model Pin {
  id        String   @id @default(cuid())
  userId    String
  contentId String
  isPublic  Boolean  @default(true)
  createdAt DateTime @default(now())
  content   Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, contentId])
  @@index([contentId])
  @@index([userId])
  @@map("pins")
}

model Purchase {
  id              String       @id @default(cuid())
  userId          String
  contentId       String?
  price           Int
  currency        String       @default("CLP")
  status          String       @default("pending")
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  completedAt     DateTime?
  transactionId   String?      @unique
  contentSnapshot Json
  content         Content?     @relation(fields: [contentId], references: [id])
  transaction     Transaction? @relation(fields: [transactionId], references: [id])
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([contentId])
  @@index([status])
  @@map("purchases")
}

model Transaction {
  id                String    @id @default(cuid())
  token             String?   @unique
  buyOrder          String    @unique
  sessionId         String
  amount            Int
  currency          String    @default("CLP")
  status            String    @default("pending")
  authorizationCode String?
  responseCode      Int?
  paymentTypeCode   String?
  accountingDate    String?
  transactionDate   DateTime?
  url               String?
  returnUrl         String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  userId            String
  contentIds        String[]
  purchase          Purchase?
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([buyOrder])
  @@index([status])
  @@map("transactions")
}
