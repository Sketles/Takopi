generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

// ============ ENUMS ============
enum UserRole {
  Explorer
  Artist
  Maker
  Admin
}

enum ContentType {
  modelos3d
  avatares
  texturas
  musica
  animaciones
  otros
}

enum License {
  personal
  commercial
  streaming
}

enum GenStatus {
  PENDING
  IN_PROGRESS
  SUCCEEDED
  FAILED
  CANCELED
}

// ============ MODELS ============
model User {
  id           String        @id @default(cuid())
  username     String        @unique
  email        String        @unique
  password     String
  role         UserRole      @default(Explorer)
  avatar       String?
  banner       String?
  bio          String?
  location     String?
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  comments     Comment[]
  contents     Content[]
  following    Follow[]      @relation("UserFollowing")
  followers    Follow[]      @relation("UserFollowers")
  likes        Like[]
  pins         Pin[]
  purchases    Purchase[]
  transactions Transaction[]
  collections  Collection[]
  generations  Generation[]
  printOrders  PrintOrder[]

  @@map("users")
}

model Content {
  id               String      @id @default(cuid())
  title            String
  description      String
  shortDescription String?
  contentType      ContentType
  files            Json
  coverImage       String?
  additionalImages String[]    @default([])
  price            Int         @default(0)
  currency         String      @default("CLP")
  isFree           Boolean     @default(false)
  license          License     @default(personal)
  customLicense    String?
  isPublished      Boolean     @default(false)
  isListed         Boolean     @default(true)
  tags             String[]
  customTags       String[]
  views            Int         @default(0)
  downloads        Int         @default(0)
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  publishedAt      DateTime?
  authorId         String
  deletedAt        DateTime?
  comments         Comment[]
  author           User        @relation(fields: [authorId], references: [id], onDelete: Cascade)
  likes            Like[]
  pins             Pin[]
  purchases        Purchase[]
  collectionItems  CollectionItem[]
  printOrders      PrintOrder[]

  @@index([authorId])
  @@index([contentType])
  @@index([isPublished])
  @@index([createdAt])
  @@index([views])
  @@index([price])
  @@index([isListed])
  @@index([contentType, isPublished])
  @@index([authorId, isPublished])
  @@map("contents")
}

model Comment {
  id        String   @id @default(cuid())
  text      String
  contentId String
  userId    String
  parentId  String?  // Para respuestas anidadas
  likeCount Int      @default(0)
  likedBy   String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  content   Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent    Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")

  @@index([contentId])
  @@index([userId])
  @@index([parentId])
  @@map("comments")
}

model Like {
  id        String   @id @default(cuid())
  contentId String
  userId    String
  createdAt DateTime @default(now())
  content   Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([contentId, userId])
  @@index([contentId])
  @@index([userId])
  @@map("likes")
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())
  follower    User     @relation("UserFollowing", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("UserFollowers", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("follows")
}

model Pin {
  id        String   @id @default(cuid())
  userId    String
  contentId String
  isPublic  Boolean  @default(true)
  createdAt DateTime @default(now())
  content   Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, contentId])
  @@index([contentId])
  @@index([userId])
  @@map("pins")
}

model Purchase {
  id              String       @id @default(cuid())
  userId          String
  contentId       String?
  price           Int
  currency        String       @default("CLP")
  status          String       @default("pending")
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  completedAt     DateTime?
  transactionId   String?      @unique
  contentSnapshot Json
  content         Content?     @relation(fields: [contentId], references: [id])
  transaction     Transaction? @relation(fields: [transactionId], references: [id])
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  printOrder      PrintOrder?

  @@index([userId])
  @@index([contentId])
  @@index([status])
  @@map("purchases")
}

model Transaction {
  id                String    @id @default(cuid())
  token             String?   @unique
  buyOrder          String    @unique
  sessionId         String
  amount            Int
  currency          String    @default("CLP")
  status            String    @default("pending")
  authorizationCode String?
  responseCode      Int?
  paymentTypeCode   String?
  accountingDate    String?
  transactionDate   DateTime?
  url               String?
  returnUrl         String?
  metadata          Json?     // Datos adicionales (printConfig, shippingData, etc.)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  userId            String
  contentIds        String[]
  purchase          Purchase?
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  printOrder        PrintOrder?

  @@index([userId])
  @@index([token])
  @@index([buyOrder])
  @@index([status])
  @@map("transactions")
}

model Collection {
  id          String           @id @default(cuid())
  userId      String
  title       String
  description String?
  isPublic    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  items       CollectionItem[]

  @@index([userId])
  @@index([userId, isPublic])
  @@map("collections")
}

model CollectionItem {
  id           String     @id @default(cuid())
  collectionId String
  contentId    String
  addedAt      DateTime   @default(now())
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  content      Content    @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@unique([collectionId, contentId])
  @@index([collectionId])
  @@index([contentId])
  @@map("collection_items")
}

// ============ 3D PRINT ORDERS ============
enum PrintStatus {
  PENDING      // Esperando confirmación de pago
  CONFIRMED    // Pago confirmado, en cola
  PROCESSING   // Preparando impresión
  PRINTING     // Imprimiendo
  QUALITY_CHECK // Control de calidad
  SHIPPED      // Enviado
  DELIVERED    // Entregado
  CANCELLED    // Cancelado
  FAILED       // Falló impresión
}

model PrintOrder {
  id              String       @id @default(cuid())
  userId          String
  contentId       String       // Modelo 3D que se imprime
  purchaseId      String?      @unique // Compra asociada del modelo digital
  transactionId   String?      @unique // Transacción de Webpay
  
  // Configuración de impresión
  material        String       // PLA, ABS, PETG, Resina
  quality         String       // draft, standard, high
  scale           Float        @default(1.0)
  color           String?
  infill          Int          @default(20) // % de relleno
  notes           String?      // Instrucciones especiales
  
  // Precios
  printPrice      Int          // Precio del servicio de impresión
  modelPrice      Int          @default(0) // Precio del modelo (si aplica)
  shippingPrice   Int          @default(0)
  totalPrice      Int
  currency        String       @default("CLP")
  
  // Estado y tracking
  status          PrintStatus  @default(PENDING)
  statusHistory   Json         @default("[]") // [{status, timestamp, note}]
  estimatedDays   Int?         // Días estimados de entrega
  
  // Datos de envío
  shippingAddress Json?        // {street, city, region, postalCode, country}
  shippingMethod  String?      // pickup, standard, express
  trackingNumber  String?
  trackingUrl     String?
  carrier         String?      // Correos Chile, Starken, etc.
  
  // Timestamps
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  confirmedAt     DateTime?    // Cuando se confirmó el pago
  startedAt       DateTime?    // Cuando empezó la impresión
  shippedAt       DateTime?
  deliveredAt     DateTime?
  
  // Relaciones
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  content         Content      @relation(fields: [contentId], references: [id])
  purchase        Purchase?    @relation(fields: [purchaseId], references: [id])
  transaction     Transaction? @relation(fields: [transactionId], references: [id])

  @@index([userId])
  @@index([contentId])
  @@index([status])
  @@index([createdAt])
  @@map("print_orders")
}

// ============ AI GENERATION ============
model Generation {
  id            String      @id @default(cuid())
  userId        String
  taskId        String      @unique // ID de tarea en Meshy
  taskType      String      @default("text-to-3d") // text-to-3d, image-to-3d, text-to-3d-refine, retexture
  prompt        String?
  imageUrl      String?     // Para image-to-3d
  status        GenStatus   @default(PENDING)
  progress      Int         @default(0)
  modelUrl      String?     // URL del modelo GLB
  thumbnailUrl  String?
  artStyle      String?
  aiModel       String      @default("latest")
  creditsUsed   Int         @default(0)
  errorMessage  String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  completedAt   DateTime?
  
  // Campos para texturas (nuevos)
  mode          String?     @default("preview") // preview, refine
  enablePbr     Boolean     @default(false)
  texturePrompt String?
  previewTaskId String?     // Para refine: ID de la tarea preview original
  hasTextures   Boolean     @default(false)

  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("generations")
}

// ============ COIN TRANSACTIONS ============
model CoinTransaction {
  id          String   @id @default(cuid())
  userId      String
  buyOrder    String   @unique
  sessionId   String
  packageId   String   // starter, creator, pro, ultimate
  coins       Int
  amount      Int      // Precio en CLP
  status      String   @default("PENDING") // PENDING, COMPLETED, FAILED
  token       String?  // Token de Webpay
  
  // Datos de respuesta de Webpay
  authorizationCode String?
  paymentTypeCode   String?
  responseCode      Int?
  cardNumber        String?
  transactionDate   DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@index([buyOrder])
  @@index([status])
  @@map("coin_transactions")
}

